<!doctype html>
<html lang="fr" class="cursor-foot">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Joyeux anniversaire â€¢ Ã‰lise</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="dist/tailwind.css" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <canvas id="particles"></canvas>

  <div class="final-page-wrap">
    <h1 class="final-title">Joyeux anniversaire Ã‰lise âœ¨</h1>
    <p class="final-sub">Je t'aime de touuuut mon coeurrrr</p>
    <span class="sparkles" aria-hidden="true"></span>
    <div class="final-hearts-large float-up" aria-hidden="true">ðŸ’– ðŸ’– ðŸ’–</div>

    <div class="final-actions">
      <button type="button" class="btn btn-2 btn-2i" id="replayBtn" aria-label="Revenir Ã  la lettre">Revenir</button>
      <button type="button" class="btn btn-2 btn-2j" id="galleryBtn" aria-label="Voir les souvenirs">Souvenirs</button>
    </div>

    <p class="final-note">Reviens Ã  la lettre pour tout revivre, ou file vers nos souvenirs.</p>
  </div>

  <script>
    (function () {
      const canvas = document.getElementById('particles');
      const ctx = canvas && canvas.getContext ? canvas.getContext('2d') : null;
      if (!canvas || !ctx) {
        return;
      }

      const DPR = window.devicePixelRatio || 1;
      const particles = [];
      let lastTs = 0;

      function resize() {
        canvas.width = window.innerWidth * DPR;
        canvas.height = window.innerHeight * DPR;
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
      }

      function rand(min, max) {
        return Math.random() * (max - min) + min;
      }

      function createHeart(x, y) {
        particles.push({
          type: 'heart',
          x,
          y,
          vx: rand(-0.6, 0.6),
          vy: rand(-1.0, -0.2),
          life: rand(2200, 4200),
          size: rand(12, 30),
          age: 0,
          rot: rand(-0.6, 0.6)
        });
      }

      function createConfetti(x, y) {
        const palette = ['#ffd6e0', '#f6e7ff', '#ffe9d6', '#fef3c7', '#f7d5f0'];
        particles.push({
          type: 'confetti',
          x,
          y,
          vx: rand(-1, 1),
          vy: rand(0.2, 1.0),
          life: rand(2800, 5200),
          size: rand(6, 12),
          age: 0,
          rot: rand(-2, 2),
          color: palette[Math.floor(Math.random() * palette.length)]
        });
      }

      function tick(ts) {
        if (!lastTs) lastTs = ts;
        const dt = ts - lastTs;
        lastTs = ts;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (let i = particles.length - 1; i >= 0; i -= 1) {
          const p = particles[i];
          p.age += dt;
          const ratio = p.age / p.life;
          if (ratio >= 1) {
            particles.splice(i, 1);
            continue;
          }

          if (p.type === 'heart') {
            p.x += p.vx * (dt / 16);
            p.y += p.vy * (dt / 16);
            p.vy -= 0.0018 * (dt / 16);

            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot + Math.sin(p.age / 240) * 0.06);
            const scale = 1 - ratio * 0.25;
            ctx.scale(scale, scale);
            const s = p.size;
            ctx.beginPath();
            ctx.fillStyle = `rgba(255,150,185,${1 - ratio})`;
            ctx.moveTo(0, -s / 6);
            ctx.bezierCurveTo(-s / 2, -s / 2, -s, s / 6, 0, s);
            ctx.bezierCurveTo(s, s / 6, s / 2, -s / 2, 0, -s / 6);
            ctx.fill();
            ctx.restore();
          } else {
            p.x += p.vx * (dt / 16);
            p.y += p.vy * (dt / 16);
            p.vy += 0.0012 * (dt / 16);

            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot + p.age / 600);
            ctx.globalAlpha = 1 - ratio * 0.6;
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
            ctx.restore();
          }
        }

        requestAnimationFrame(tick);
      }

      function celebrate() {
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;

        for (let i = 0; i < 40; i += 1) {
          setTimeout(() => createHeart(rand(0, window.innerWidth), -rand(0, 200)), i * 28);
        }
        for (let i = 0; i < 48; i += 1) {
          setTimeout(() => createHeart(cx + rand(-220, 220), cy + rand(-80, 160)), 600 + i * 36);
        }
        for (let i = 0; i < 70; i += 1) {
          setTimeout(() => createConfetti(rand(0, window.innerWidth), rand(-40, 60)), i * 60);
        }
      }

      window.addEventListener('resize', resize, { passive: true });
      resize();
      celebrate();
      requestAnimationFrame(tick);

      setInterval(() => {
        if (Math.random() < 0.45) {
          createHeart(rand(40, window.innerWidth - 40), window.innerHeight + 20);
        }
      }, 1400);

      const replayBtn = document.getElementById('replayBtn');
      if (replayBtn) {
        replayBtn.addEventListener('click', () => {
          try {
            sessionStorage.setItem('bgm:skipLast', '1');
          } catch (error) {
            /* ignore */
          }
          window.location.href = 'index.html';
        });
      }

      const galleryBtn = document.getElementById('galleryBtn');
      if (galleryBtn) {
        galleryBtn.addEventListener('click', () => {
          try {
            sessionStorage.setItem('bgm:skipLast', '1');
          } catch (error) {
            /* ignore */
          }
          window.location.href = 'ressources/diaporama.html';
        });
      }
    })();
  </script>
  <script>
    (function () {
      if (typeof window === 'undefined') {
        return;
      }

      const TRACKS = [
        { id: 'frambosise', file: 'frambosise.m4a', title: 'Frambosise' },
        { id: 'histoire', file: 'histoire.m4a', title: 'Histoire' },
        { id: 'senora', file: 'senora.m4a', title: 'SeÃ±ora' }
      ];

      const STORAGE = {
        last: 'bgm:lastTrack',
        volume: 'bgm:volume',
        skip: 'bgm:skipLast'
      };

      const audio = new Audio();
      audio.loop = true;

      let currentTrackId = null;
      let pendingPlay = null;

      const readStoredVolume = () => {
        try {
          const raw = localStorage.getItem(STORAGE.volume);
          const parsed = raw === null ? NaN : Number.parseFloat(raw);
          if (Number.isFinite(parsed)) {
            return Math.min(1, Math.max(0, parsed));
          }
        } catch (error) {
          /* ignore */
        }
        return 0.6;
      };

      let volume = readStoredVolume();
      audio.volume = volume;

      const trackLabelFor = (id) => {
        const found = TRACKS.find((item) => item.id === id);
        return found ? found.title : null;
      };

      const widget = document.createElement('div');
      widget.className = 'bgm-widget';

      const header = document.createElement('header');
      const title = document.createElement('p');
      title.className = 'bgm-widget-title';
      title.textContent = 'Fond musical';
      const trackLine = document.createElement('p');
      trackLine.className = 'bgm-widget-track';
      trackLine.textContent = 'Lecture : â€”';
      header.appendChild(title);
      header.appendChild(trackLine);

      const changeBtn = document.createElement('button');
      changeBtn.type = 'button';
      changeBtn.className = 'love-control-button';
      changeBtn.textContent = 'Changer ðŸŽµ';

      const volumeLabel = document.createElement('label');
      volumeLabel.className = 'bgm-volume-label';
      volumeLabel.setAttribute('for', 'finalBgmVolume');
      const volumeText = document.createElement('span');
      volumeText.textContent = `Volume (${Math.round(volume * 100)}%)`;
      const slider = document.createElement('input');
      slider.type = 'range';
      slider.id = 'finalBgmVolume';
      slider.min = '0';
      slider.max = '100';
      slider.step = '1';
      slider.value = String(Math.round(volume * 100));
      slider.className = 'love-speed-slider love-volume-slider';

      volumeLabel.appendChild(volumeText);
      volumeLabel.appendChild(slider);

      widget.appendChild(header);
      widget.appendChild(changeBtn);
      widget.appendChild(volumeLabel);

      document.body.appendChild(widget);

      const updateTrackLine = () => {
        const label = currentTrackId ? trackLabelFor(currentTrackId) : null;
        trackLine.textContent = label ? `Lecture : ${label}` : 'Lecture : â€”';
      };

      const updateVolumeText = () => {
        volumeText.textContent = `Volume (${Math.round(volume * 100)}%)`;
      };

      const selectTrack = (options = {}) => {
        const { preferDifferent = false, excludeCurrent = false } = options;

        const exclusion = new Set();
        if (preferDifferent) {
          try {
            const last = localStorage.getItem(STORAGE.last);
            if (last) {
              exclusion.add(last);
            }
          } catch (error) {
            /* ignore */
          }
        }
        if (excludeCurrent && currentTrackId) {
          exclusion.add(currentTrackId);
        }

        let pool = TRACKS.slice();
        if (pool.length > 1 && exclusion.size) {
          pool = pool.filter((track) => !exclusion.has(track.id));
          if (!pool.length) {
            pool = TRACKS.slice();
          }
        }

        const chosen = pool[Math.floor(Math.random() * pool.length)];
        if (!chosen) {
          return;
        }

        currentTrackId = chosen.id;
        try {
          localStorage.setItem(STORAGE.last, chosen.id);
        } catch (error) {
          /* ignore */
        }

        audio.src = `ressources/song/${chosen.file}`;
        audio.currentTime = 0;
        audio.volume = volume;

        const attempt = audio.play();
        if (attempt && typeof attempt.catch === 'function') {
          attempt
            .then(() => {
              pendingPlay = null;
            })
            .catch((error) => {
              if (error?.name === 'NotAllowedError' || error?.name === 'AbortError' || error?.name === 'NotSupportedError') {
                pendingPlay = audio;
              }
            });
        } else {
          pendingPlay = null;
        }

        updateTrackLine();
      };

      const resumePending = () => {
        if (pendingPlay) {
          pendingPlay.volume = volume;
          const attempt = pendingPlay.play();
          if (attempt && typeof attempt.catch === 'function') {
            attempt.catch(() => {});
          }
          pendingPlay = null;
        }
      };

      changeBtn.addEventListener('click', () => {
        selectTrack({ preferDifferent: true, excludeCurrent: true });
      });

      slider.addEventListener('input', (event) => {
        const value = Number(event.target.value);
        if (Number.isNaN(value)) {
          return;
        }
        volume = Math.min(1, Math.max(0, value / 100));
        audio.volume = volume;
        if (pendingPlay) {
          pendingPlay.volume = volume;
        }
        updateVolumeText();
        try {
          localStorage.setItem(STORAGE.volume, volume.toFixed(2));
        } catch (error) {
          /* ignore */
        }
      });

      const preferDifferentOnLoad = (() => {
        let shouldDiffer = false;
        try {
          const skip = sessionStorage.getItem(STORAGE.skip) === '1';
          if (skip) {
            shouldDiffer = true;
            sessionStorage.removeItem(STORAGE.skip);
          }
        } catch (error) {
          /* ignore */
        }
        return shouldDiffer;
      })();

      selectTrack({ preferDifferent: preferDifferentOnLoad });
      updateVolumeText();

      window.addEventListener('pointerdown', resumePending, { passive: true });
      window.addEventListener('keydown', resumePending);

      const cleanup = () => {
        window.removeEventListener('pointerdown', resumePending);
        window.removeEventListener('keydown', resumePending);
        pendingPlay = null;
        audio.pause();
        audio.src = '';
      };

      window.addEventListener('pagehide', cleanup, { once: true });
      window.addEventListener('beforeunload', cleanup, { once: true });
    })();
  </script>
  <script>
    (function () {
      const supportsPointer = typeof window !== 'undefined' && (!window.matchMedia || !window.matchMedia('(pointer: coarse)').matches);
      if (!supportsPointer) {
        return;
      }

  const root = document.documentElement;
  root.classList.add('custom-cursor-active', 'cursor-foot');
  root.classList.remove('cursor-hand');

      const cursorEl = document.createElement('div');
      cursorEl.className = 'custom-hand-cursor';
      cursorEl.dataset.hidden = 'true';
      cursorEl.dataset.active = 'false';
      cursorEl.dataset.variant = 'default';
      document.body.appendChild(cursorEl);

      let rafId = 0;
      let lastX = window.innerWidth / 2;
      let lastY = window.innerHeight / 2;

      const scheduleTransform = (x, y) => {
        lastX = x;
        lastY = y;
        if (rafId) return;
        rafId = window.requestAnimationFrame(() => {
          cursorEl.style.setProperty('--cursor-x', `${lastX}px`);
          cursorEl.style.setProperty('--cursor-y', `${lastY}px`);
          rafId = 0;
        });
      };

      const show = () => {
        cursorEl.dataset.hidden = 'false';
      };

      const hide = () => {
        cursorEl.dataset.hidden = 'true';
      };

      const interactiveSelector = 'button, a, .btn';

      const updateVariant = (target) => {
        if (!target || typeof target.closest !== 'function') {
          cursorEl.dataset.variant = 'default';
          return;
        }
        cursorEl.dataset.variant = target.closest(interactiveSelector) ? 'interactive' : 'default';
      };

      const handlePointerMove = (event) => {
        if (event.pointerType === 'touch') {
          return;
        }
        show();
        scheduleTransform(event.clientX, event.clientY);
        updateVariant(event.target);
      };

      const handlePointerDown = (event) => {
        if (event.pointerType === 'touch') {
          return;
        }
        cursorEl.dataset.active = 'true';
      };

      const handlePointerUp = (event) => {
        if (event.pointerType === 'touch') {
          return;
        }
        cursorEl.dataset.active = 'false';
        window.requestAnimationFrame(() => {
          const el = document.elementFromPoint(lastX, lastY);
          updateVariant(el);
        });
      };

      const handleVisibilityChange = () => {
        if (document.hidden) {
          hide();
        }
      };

      const handleMouseLeave = (event) => {
        if (!event.relatedTarget) {
          hide();
        }
      };

      scheduleTransform(lastX, lastY);

      window.addEventListener('pointermove', handlePointerMove, { passive: true });
      window.addEventListener('pointerdown', handlePointerDown, { passive: true });
      window.addEventListener('pointerup', handlePointerUp, { passive: true });
      window.addEventListener('pointercancel', handlePointerUp, { passive: true });
      window.addEventListener('blur', hide, { passive: true });
      document.addEventListener('visibilitychange', handleVisibilityChange);
      document.addEventListener('mouseleave', handleMouseLeave);

      const cleanup = () => {
        window.removeEventListener('pointermove', handlePointerMove);
        window.removeEventListener('pointerdown', handlePointerDown);
        window.removeEventListener('pointerup', handlePointerUp);
        window.removeEventListener('pointercancel', handlePointerUp);
        window.removeEventListener('blur', hide);
        document.removeEventListener('visibilitychange', handleVisibilityChange);
        document.removeEventListener('mouseleave', handleMouseLeave);
        if (rafId) {
          window.cancelAnimationFrame(rafId);
        }
        if (cursorEl.parentNode) {
          cursorEl.parentNode.removeChild(cursorEl);
        }
  root.classList.remove('custom-cursor-active');
      };

      window.addEventListener('pagehide', cleanup, { once: true });
      window.addEventListener('beforeunload', cleanup, { once: true });
    })();
  </script>
</body>
</html>
